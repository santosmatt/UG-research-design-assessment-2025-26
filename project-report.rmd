---
title: "Group project assessment"
author: 'B229565'
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

NOTE: Please don't edit this template directly. Use `File` > `Save as` to create a copy of this document, rename it (remove the word "template" from the file name) and use that new version to write your report. Make sure to also update the Title and Author fields in the YAML of your .Rmd file.

## Task 1: Reproducing and improving figures

```{r importing-required-packages}
needed_pkgs <- c("tidyverse", "here", "ggtext")
for (pkg in needed_pkgs) {
if (!require(pkg, character.only = TRUE)) {
install.packages(pkg)
library(pkg, character.only = TRUE)
} else {
library(pkg, character.only = TRUE)
}}
```


```{r load-wrangle}
# load and wrangle the data here

postpartum_depression_data_raw <- 
  readr::read_csv(here::here("data", "HIIT-postpartum-depression.csv")) %>% 
  janitor::clean_names()

postpartum_depression_data <- postpartum_depression_data_raw %>% 
  select(intervention_group, 
         edinburg_postnatal_depression_scale_score, 
         pre_fs_scale,
         post_fs_score,
         postnatal_florishing_scale_score,
         pre_sf_12_pcs_physicalhealthscale,
         post_sf12_pcs,
         postpre_sf12_pcs
         ) %>% 
  mutate(postnatal_depression_score = 
           as.numeric(edinburg_postnatal_depression_scale_score) %>% 
           cut(breaks = c(0,9,12,30), 
               labels = c("range indicating the norm (below 10 points)",
                      "slightly increased severity PDD symptoms (10-11 points)",
                      "increased severity of PDD symptoms"),
               include.lowest = TRUE))

```

### Figure 3 Reproduction
```{r figure-3}
hiit_ppd_raw <-read_csv(here("data", "HIIT-postpartum-depression.csv"), na = c("", "NA", "#NULL!", "NULL")) 

# Fig 3 Data wrangling
fig3_raw <- hiit_ppd_raw %>%
  mutate(
    group = case_when(
      `Intervention group` == 1 ~ "HIIT",
      `Intervention group` == 2 ~ "EDU",
      TRUE ~ NA_character_
    ),
    epds = as.numeric(`Edinburg Postnatal Depression Scale Score`),
    post_bdi2 = as.numeric(`POST depression BDI-II score`)
  ) %>%
  filter(!is.na(group), !is.na(epds), !is.na(post_bdi2)) %>%
  mutate(
    epds_cat = case_when(
      epds < 10  ~ "<10",
      epds <= 11 ~ "10-11",
      TRUE       ~ "≥12"
    ),
    epds_cat = factor(epds_cat, levels = c("<10", "10-11", "≥12")),
    group = factor(group, levels = c("HIIT", "EDU"))
  )


# Summarise for stacked proportions
fig3_sum <- fig3_raw %>%
  count(group, epds_cat, name = "n") %>%
  group_by(group) %>%
  mutate(
    pct = n / sum(n),
    label = paste0(round(pct * 100, 1), "%")
  ) %>%
  ungroup()

fig3_sum %>% group_by(group) %>% summarise(total = sum(n), .groups = "drop") #sanity check


# Figure Plot (Original)
ggplot(fig3_sum, aes(x = group, y = pct, fill = epds_cat)) +
  geom_col(width = 0.25, position = position_stack(reverse = TRUE)) +
  coord_flip() +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, 0.1),
    labels = scales::percent_format(accuracy = 0.01)
  ) +
  scale_fill_manual(
    values = c("<10" = "#8DB6F8",
               "10-11" = "#083B92",
               "≥12"  = "#C32113"),
    labels = c(
      "<10" = "range indicating the norm (below 10 points)",
      "10-11" = "slightly increased severity of PPD symptoms (10–11 points)",
      "≥12" = "increased severity of PPD symptoms (12 or more points)"
    )
  ) +
  scale_x_discrete(
    labels = c(
      "HIIT" = "HIIT – High Intensity Interval Training Group",
      "EDU"  = "EDU – Educational Intervention Group"
    )
  ) +
  labs(x = NULL, y = NULL, fill = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )
```

### Figure 3 Improvement (75 words)
The original Figure 3 is a 100% stacked bar chart, which makes it hard to compare the HIIT and EDU groups within each EPDS category because differences must be visually estimated from segment lengths. We improved readability by switching to a grouped bar chart (side-by-side bars for HIIT vs EDU in each category), allowing direct group comparisons for each cut-off band. We also added percentage labels to remove ambiguity and reduce reliance on visual approximation.
```{r}
fig3_sum_imp <- fig3_raw %>%
  count(group, epds_cat, name = "n") %>%
  group_by(group) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ungroup()

# group totals for legend labels
group_totals <- fig3_sum_imp %>%
  group_by(group) %>%
  summarise(total = sum(n), .groups = "drop")

# 2) Improved Plot
ggplot(fig3_sum_imp, aes(x = epds_cat, y = pct, fill = group)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = paste0(round(pct, 1), "%")),
    position = position_dodge(width = 0.8),
    vjust = -0.5,
    size = 3
  ) +
  scale_fill_manual(
    values = c("HIIT" = "#0072B2", "EDU" = "#D55E00"),
    breaks = c("HIIT", "EDU"),
    labels = paste0(group_totals$group, " (n=", group_totals$total, ")")
  ) +
  scale_x_discrete(
    labels = c(
      "<10"   = "<10 (No depression)",
      "10-11" = "10–11 (Borderline)",
      "≥12"   = "≥12 (Elevated)"
    )
  ) +
  scale_y_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, 10),
    expand = expansion(mult = c(0, 0.10))
  ) +
  labs(
    x = "Postpartum EPDS category",
    y = "Participants (%)",
    fill = "Group"
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "top"
  )
```


### Figure 4
```{r figure-4}
fig4_long <- hiit_ppd_raw %>%
  mutate(
    group = case_when(
      `Intervention group` == 1 ~ "HIIT",
      `Intervention group` == 2 ~ "EDU",
      TRUE ~ NA_character_
    ),
    post_bdi2 = `POST depression BDI-II score` %>%
      as.character() %>%
      na_if("#NULL!") %>%
      as.numeric(), 

    pre_fs  = `PRE FS scale` %>%
      as.character() %>%
      na_if("#NULL!") %>%
      as.numeric(),

    post_fs = `POST FS score` %>%
      as.character() %>%
      na_if("#NULL!") %>%
      as.numeric(),

    postnatal_fs = `Postnatal Florishing scale score` %>%
      as.character() %>%
      na_if("#NULL!") %>%
      as.numeric()
  ) %>%
  filter(
    !is.na(group),
    !is.na(post_bdi2),      # Remove all the NULLS
    !is.na(pre_fs),
    !is.na(post_fs),
    !is.na(postnatal_fs)
  ) %>%
  select(group, pre_fs, post_fs, postnatal_fs) %>%
  pivot_longer(
    cols = c(pre_fs, post_fs, postnatal_fs),
    names_to = "time",
    values_to = "fs"
  ) %>%
  mutate(
    group = factor(group, levels = c("HIIT", "EDU")),
    time = factor(
      time,
      levels = c("pre_fs", "post_fs", "postnatal_fs"),
      labels = c(
        "Before the intervention\n(II trimester of pregnancy)",
        "After the intervention\n(III trimester of pregnancy)",
        "Follow-up\n(± 5 months postpartum)"
      )))

fig4_sum <- fig4_long %>%
  group_by(group, time) %>%
  summarise(
    mean = mean(fs, na.rm = TRUE),
    sd   = sd(fs, na.rm = TRUE),
    .groups = "drop"
  ) # Summary for plots

fig4_lab <- fig4_sum %>%
  group_by(time) %>%
  mutate(
    nudge_y = if_else(mean == max(mean, na.rm = TRUE), 0.55, -0.55),
    nudge_x = if_else(time == levels(time)[3], 0.12, -0.12)
  ) %>%
  ungroup()

ggplot(fig4_sum, aes(x = time, y = mean, group = group, linetype = group)) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
                width = 0.08, linewidth = 0.6) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2.2)+
  geom_text(
    data = fig4_lab,
    aes(label = sprintf("M = %.2f", mean)),
    nudge_x = fig4_lab$nudge_x,
    nudge_y = fig4_lab$nudge_y,
    size = 3
  )+
  scale_linetype_manual(
    values = c("HIIT" = "solid", "EDU" = "dotted"),
    labels = c("HIIT – High Intensity Interval Training Group",
               "EDU – Educational Intervention Group")
  ) +
  scale_y_continuous(
    limits = c(40, 60),
    breaks = seq(40, 60, 2),
    labels = function(x) sprintf("%.2f", x)
  ) +
  labs(
    x = "<b>Psychological well-being</b> <i>(measured with the Flourishing Scale)</i>",
    y = NULL,
    linetype = NULL
  ) +
  theme_light()+
  theme(
    axis.title.x = element_markdown(
      size = 12,
      margin = margin(t = 10, b = 5)
    ),
    legend.position = "bottom",
    legend.direction = "vertical"
  )

```


```{r}
# Load required library
library(tidyverse)

tidy_data <- hiit_ppd_raw %>%
  # Select relevant columns and rename for clarity
  select(group = `Intervention group`, 
         Pre = `PRE FS scale`, 
         Post = `POST FS score`, 
         Postpartum = `Postnatal Florishing scale score`) %>%
  # Pivot to long format: one row per participant per time
  pivot_longer(cols = c(Pre, Post, Postpartum), names_to = "Time", values_to = "Flourishing") %>%
  # Recode group and time as factors with meaningful labels
  mutate(group = factor(group, levels = c(1, 2), labels = c("HIIT", "EDU")),
         Time = factor(Time, levels = c("Pre", "Post", "Postpartum")))

# 2. Compute group-wise summary statistics (mean and 95% CI) ----
summary_df <- tidy_data %>%
  group_by(group, Time) %>%
  summarise(
    n = sum(!is.na(Flourishing)),                   # sample size per group per time
    mean = mean(Flourishing, na.rm = TRUE),         # mean flourishing score
    sd   = sd(Flourishing, na.rm = TRUE)            # standard deviation
  ) %>%
  mutate(
    se    = sd / sqrt(n),                           # standard error
    ci    = qt(0.975, df = n - 1) * se,             # 95% confidence interval half-width
    lower = mean - ci, 
    upper = mean + ci
  )

# Prepare labels for plotting mean values (offset higher group label above the lower)
summary_df <- summary_df %>%
  group_by(Time) %>%
  mutate(label   = round(mean, 1),
         label_y = ifelse(mean == max(mean, na.rm = TRUE),
                          mean + 0.3,    # place label slightly above higher mean
                          mean - 0.3))   # place label slightly below lower mean

# 3. Create the line plot with ggplot2 ----
# Define color-blind friendly colors and shapes for the two groups
group_colors  <- c("HIIT" = "#0072B2", "EDU" = "#D55E00")  # blue for HIIT, orange for EDU
group_shapes  <- c("HIIT" = 16, "EDU" = 17)               # 16 = circle, 17 = triangle
group_lines   <- c("HIIT" = "solid", "EDU" = "dashed")    # solid line for HIIT, dashed for EDU

# Calculate position for significance asterisk (above EDU group's postpartum point)
edu_post_upper <- summary_df %>% filter(group == "EDU", Time == "Postpartum") %>% pull(upper)

p <- ggplot(summary_df, aes(x = as.numeric(Time), y = mean, color = group)) +
  # Mean trends for each group
  geom_line(aes(linetype = group), size = 1) +
  geom_point(aes(shape = group), size = 3) +
  # Error bars for 95% CI
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
  # Numeric mean value labels (higher group label above the lower)
  geom_text(aes(y = label_y, label = label), show.legend = FALSE, size = 3) +
  # Direct labels for each line at the final time point (group names)
  geom_text(data = filter(summary_df, Time == "Postpartum"),
            aes(label = group), fontface = "bold",
            nudge_x = 0.15, show.legend = FALSE) +
  # Annotation: asterisk marking significant within-group change for EDU
  annotate("text", x = 3, y = edu_post_upper + 0.5, 
           label = "*", color = "#D55E00", size = 6) +
  # Color, shape, and linetype scales
  scale_color_manual(values = group_colors) +
  scale_shape_manual(values = group_shapes) +
  scale_linetype_manual(values = group_lines) +
  # Define discrete time points on x-axis with T1, T2, T3 labels and descriptions
  scale_x_continuous(breaks = 1:3,
                     labels = c("T1\n(Baseline)", 
                                "T2\n(Post-intervention)", 
                                "T3\n(5-mo postpartum)"),
                     expand = expansion(mult = c(0.05, 0.1))) +
  # Axis labels (bold outcome name, italicized scale description) and caption
  labs(x = "Time of assessment",
       y = expression(bold("Psychological well-being") * " (" * italic("Flourishing Scale") * " score)"),
       caption = "Mean flourishing (psychological well-being) scores at baseline (T1), post-intervention (T2), and 5 months postpartum (T3) for HIIT and EDU groups. Both groups showed a slight increase from T1 to T2. By T3, only the EDU group experienced a significant drop in well-being from its post-intervention level (marked with *), whereas the HIIT group maintained their post-intervention scores:contentReference[oaicite:0]{index=0}.") +
  # Theme for a clean, publication-ready look
  theme_classic(base_size = 14) +
  theme(
    legend.position = "none",            # remove legend (lines are labeled directly)
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

# 4. Display the plot
print(p)

```

### Figure 5
```{r figure-5}
# Write your code for reproducing, and then improving Figure 5. Present both figures together. Under the figures, explain how you've improved Figure 5 and why you consider this an improvement.
```


## Task 2: FAIR data principles

## Task 3: Reproducibility brief
